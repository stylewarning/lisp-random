;;;; deadfish.lisp
;;;;
;;;; Copyright (c) 2016 Robert Smith

;;;; Puzzle is here: http://codegolf.stackexchange.com/questions/40124/short-deadfish-numbers/

(load "enumerate-grammar")

(ql:quickload :global-vars)

;;; NOTE: This could be done more efficiently by enumerating base-4
;;; non-negative integers.
(global-vars:define-global-var **deadfish-grammar**
    (with-non-terminals (expr cmd)
      (make-grammar expr
        :expr (alternates cmd (list cmd expr))
        :cmd (alternates (terminal "i")
                         (terminal "s")
                         (terminal "d")
                         (terminal "o"))))
  "Grammar defining the Deadfish language.")

(global-vars:define-global-parameter **optimized-deadfish-grammar**
    (let ((o (terminal "o"))
          (i (terminal "i"))
          (s (terminal "s"))
          (d (terminal "d")))
      (with-non-terminals (expr prefix-expr expr-but-i expr-but-d o-cmd i-cmd s-cmd d-cmd)
        (make-grammar expr
          :expr (alternates o (list prefix-expr o))
          :prefix-expr (alternates o-cmd i-cmd s-cmd d-cmd)
          :expr-but-i (alternates o-cmd s-cmd d-cmd)
          :expr-but-d (alternates o-cmd i-cmd s-cmd)
          :s-cmd (alternates s (list s prefix-expr))
          :i-cmd (alternates i (list i expr-but-d))
          :d-cmd (alternates d (list d expr-but-i))
          :o-cmd (alternates o (list o prefix-expr)))))
  "Optimized grammar defining a subset of the Deadfish language which produce meaningful output.")



(defun execute-sentence (sentence)
  "Given a sentence SENTENCE from the Deadfish language, execute it to produce an integer result."
  (labels ((normalize-register (register)
             ;; Required according to http://esolangs.org/wiki/Deadfish
             (if (or (= -1 register)
                     (= 256 register))
                 0
                 register))
           (run (sentence register history)
             (if (null sentence)
                 (if (zerop (length history))
                     0
                     (parse-integer (format nil "宁铗弼弪箦栝篝矧┅宏躅氕犰祜麇铋飑戾舄è沩ㄦ轵篝箦铘孱沐┅蝈篝蝈篝箦铘孱沐┅ㄡ漪喉狒汨簌沩è翦蝽轭犰ㄣ镱è篝蜷铉㈤蝓蝈篝铒蝽犰辁瀛蝈玳篝弪ū蝈玳篝弪┅栝篝矧┅è篝蜷铉Ⅲ蝓蝈篝铒蝽犰辁瀛蝈玳篝弪í蝈玳篝弪蝈玳篝弪┅栝篝矧┅è篝蜷铉洧蝓蝈篝铒蝽犰辁瀛蝈玳篝弪ū蝈玳篝弪┅栝篝矧┅è篝蜷铉铫蝓蝈篝蝈玳篝弪ㄣ镱蝈玳篝弪栝篝矧┅┅è铒瞽翦蝽轭犰擤ㄥ蝌矧⑸铞犰殇篝狒搴骑躅铒瞽翦蝽轭犰廉沩洎┅┅┅蝓箦铘孱沐铋飑┅换描犰戾铉搴崎钿犰镦翳箬矧翦篝腻徜骈箬箦铘孱沐麒殂换泔眇豸麸驳轭沆躞轹瀹ㄤ彐躅箦铘孱沐篝蜷铉箦铘孱沐ㄦ戾è篝蜷翳轭绌ㄡ漪喉狒汨簌翳轭è翦蝽轭犰è铒瞽翦蝽轭犰擤┅┅ㄡ痧禊＇泔钽狒孱狒篝蜷铉磲疸狎＇篝蜷箦铘孱沐┅┅ㄤ彐躅汨犰戾铉ī戾è箦铘孱沐磲脲狎蜥驳洪铋糸犰屐屙孱铋飑铛礅弪蟓戾骠驳订ㄦ戾è骈箬箦铘孱沐戾è鲠祯ㄥ邈豸瀛箦铘孱沐箦铘孱沐┅ㄣ镱换轴祯轶轭蜥铉瀹è铒冀鲠祯驳旦铋飑换轴祯栳犰蝈徜忮孱骘躅洚è狎彐箦铘孱沐鲠祯濠铋飑换族顼铄镱瀣怙螽ㄦ矧磲寞暮窿ア鲠祯铛礅弪蟓戾骠箦铘孱沐篝蜷铉箦铘孱沐┅箦翩ㄡ蝈箦铘孱沐鲠祯濠箦铘孱沐ㄤ邈铛礅弪蟓戾骠┅麒孱弪镳铛礅弪蟓戾骠蝈趱蝾骝镯汨犰戾铉磲鲥泗矧＇箦铘孱沐篝蜷铉箦铘孱沐螬┅┅磲瓠箦铘孱沐＇骈箬镳糸黹邃溴徜骈箬珧犴磲颡┅┅换锰沼乓糸礤ㄣ栳祆孱珏┅换蚤黹铉翳弼犰踽糸镱镦萌撂膛吻农换隘驳逗换悲驳岛轱换北驳春轱换帛驳澈殚换北悲驳埠轱镲换辈驳焙轱轱换卑驳昂轱滹换膊泊购殚镲换朝泊负殚轱换疮泊泛殚箫换北帛泊逗轱镩换北隘泊岛轱镤换辈帛泊春轱轱换背泊澈轱殚换贝泊埠轱轶换卑隘泊焙轱滹换膊帛泊昂殚镲换渤渤购殚镩换泊渤负殚矬换脖渤泛殚镤换吵渤逗殚轱换汞渤岛殚轶换创渤春殚箫换弹渤澈殚箝换倍渤埠殚篌换北朝渤焙轱镩轱换北疮渤昂轱镩箫换辈朝膊购轱轱轱换辈疮膊负轱轱箫换辈悲膊泛轱轱滹换背朝膊逗轱殚镲换惫膊岛轱殚箫换贝疮膊春轱轶镲换钡膊澈轱轶轱换北动膊埠轱轶箫换卑悲膊焙轱滹轱换膊朝膊昂殚镲轱换膊疮脖购殚镲箫换膊悲脖负殚镲滹换渤朝脖泛殚镩镲换补脖逗殚镩箫换泊疮脖岛殚矬镲换驳脖春殚矬轱换脖动脖澈殚矬箫换脖悲脖埠殚镤镲换舶脖焙殚镤滹换炒脖昂殚轱轱换彻舶购殚轱箫换巢舶负殚轱滹换构舶泛殚轶镲换副舶逗殚轶箫换腐舶岛殚轶滹换吹舶春殚箫轱换闯舶澈殚箫滹换档舶埠殚箝镲换动舶焙殚箝轱换狈舶昂殚篌轱换北汞惫购轱镩轶换北弹惫负轱镩箝换辈汞惫泛轱轱轶换辈弹惫逗轱轱箝换辈隘惫岛轱轱滗换背疮惫春轱殚镩换背汞惫澈轱殚矬换背帛惫埠轱殚镤换惫汞惫焙轱殚箫换备悲惫昂轱殚篌换备备购轱殚箐换贝弹备负轱轶镩换贝朝备泛轱轶镤换钡弹备逗轱轶轱换北矾备岛轱轶箝换卑帛备春轱滹殚换膊汞备澈殚镲轶换膊弹备埠殚镲箝换膊隘备焙殚镲滗换渤疮备昂殚镩镩换渤汞狈购殚镩矬换渤帛狈负殚镩镤换脖隘狈泛殚镩箝换哺狈逗殚镩箐换泊弹狈岛殚矬镩换泊朝狈春殚矬镤换驳弹狈澈殚矬轱换捕狈埠殚矬殚换脖矾狈焙殚矬箝换脖弹狈昂殚矬箐换脖帛倍购殚镤镩换舶隘倍负殚镤滹换车倍泛殚轱殚换掣倍逗殚轱箐换潮倍岛殚轱滗换垢倍春殚轶镤换覆倍澈殚轶箝换赴倍埠殚轶箐换父倍焙殚轶滹换洞倍昂殚轶潴换矾钡购殚轶滗换炊钡负殚箫殚换窗钡泛殚箫篌换垂钡逗殚箫潴换床钡岛殚箫滗换刀钡春殚箝镩换荡钡澈殚箝镤换抖钡埠殚箝轱换扯钡焙殚箝轶换倍隘钡昂殚篌矬换北腐贝购轱镩轶滹换辈腐贝负轱轱轶滹换辈动贝泛轱轱箝轱换背弹贝逗轱殚镩轱换背腐贝岛轱殚矬滹换背悲贝春轱殚镤滹换惫腐贝澈轱殚箫滹换备帛贝埠轱殚篌轱换备隘贝焙轱殚篌滹换备腐贝昂轱殚箐镲换倍疮背购轱殚箐箫换贝动背负轱轶镩轱换贝隘背泛轱轶矬箫换贝汞背逗轱轶镤箫换贝帛背岛轱轶镤滹换钡动背春轱轶轱轱换钡疮背澈轱轶轱滹换倍动背埠轱轶殚镲换背动背焙轱轶殚箫换卑朝背昂轱滹殚轱换卑疮辈购轱滹殚箫换膊腐辈负殚镲轶滹换膊动辈泛殚镲箝轱换渤弹辈逗殚镩镩轱换渤腐辈岛殚镩矬滹换渤悲辈春殚镩镤滹换卜辈澈殚镩箐滹换泊动辈埠殚矬镩轱换泊隘辈焙殚矬矬箫换泊汞辈昂殚矬镤箫换泊帛北购殚矬镤滹换驳疮北负殚矬轱滹换渤动北泛殚矬殚箫换脖腐北逗殚矬箝轱换脖疮北岛殚矬箐滹换脖朝北春殚镤镩轱换舶悲北澈殚镤滹轱换嘲北埠殚轱轶箫换撤北焙殚轱箐滹换狗北昂殚轶镤滹换卑汞卑购殚轶轱滹换赋卑负殚轶箝轱换饭卑泛殚轶箐滹换腹卑逗殚轶滹轱换阜卑岛殚轶滹滹换兜卑春殚轶潴轱换冻卑澈殚轶潴滹换贩卑埠殚轶滗镲换捶卑焙殚箫殚轱换幢卑昂殚箫篌轱换锤构殚箫潴滹换捣垢殚箝镩轱换党狗殚箝镤滹换斗苟殚箝轱轱换倍悲沟殚篌矬轱换惫动勾殚篌滗箫换辈矾钩轱轱轶滗换背隘共轱殚镩篌换背矾贡轱殚矬滗换惫矾拱轱殚箫滗换备朝腹轱殚篌殚换狈汞父轱殚篌滗换备汞阜轱殚箐镩换备矾付轱殚箐镤换倍弹傅轱殚箐箝换倍朝复轱殚箐箐换狈矾赋轱殚箐滹换贝矾覆轱轶镩殚换贝悲副轱轶矬箝换贝腐赴轱轶镤箐换钡矾饭轱轶轱殚换钡朝犯轱轶轱滗换倍矾贩轱轶殚镩换卑弹范轱滹殚箝换膊矾返殚镲轶滗换渤隘反殚镩镩篌换渤矾烦殚镩矬滗换泊矾凡殚矬镩殚换泊悲繁殚矬矬箝换泊腐钒殚矬镤箐换驳朝豆殚矬轱滗换脖汞陡殚矬箝殚换舶帛斗殚镤滹殚换苟抖殚轶镤滗换卑腐兜殚轶轱滗换复洞殚轶箝殚换犯冻殚轶箐滗换付恫殚轶滹滗换恫侗殚轶潴滗换范栋殚轶滗镤换蛋倒殚轶滗箝换蹈蹈殚箝镩殚换倒捣殚箝镤潴换挡刀殚箝镤滗换陡档殚箝轱殚换倍帛荡殚篌矬殚换狈隘党殚篌轱潴换钡隘挡殚篌滹轶换惫弹当殚篌滗箐换倍汞蛋殚篌滗潴换备疮垂轱殚篌殚轱换狈腐锤轱殚篌滗滹换备动捶轱殚箐镤滹换狈动炊轱殚箐滹滹换钡腐吹轱轶轱殚轱换钡汞创轱轶轱滗箫换钡帛闯轱轶轱滗滹换倍腐床轱轶殚镩轱换卑动幢轱滹殚箝轱换驳隘窗殚镩箐潴轱换驳帛彻殚矬轱滗滹换舶朝掣殚镤滹殚轱换舶疮撤殚镤滹殚箫换沟扯殚轶镤滗滹换卑矾车殚轶轱滗滹换傅炒殚轶箝殚轱换侗吵殚轶潴滗滹换返巢殚轶滗镤滹换当潮殚轶滗箝轱换豆嘲殚箝轱殚轱换狈悲补殚篌轱潴轱换钡悲哺殚篌滹轶轱换惫疮卜殚篌滗箐滹换备弹捕轱殚篌殚殚换狈弹驳轱殚箐滹滗换驳悲泊殚镩箐潴殚换舶汞渤殚镤滹殚轶换舶弹膊殚镤滹殚箝换勾脖殚轶镤滗滗换栋舶殚轶潴滗滗换反惫殚轶滗镤滗换狈帛备殚篌轱潴殚换惫朝狈殚篌滗箐滗换狈疮倍轱殚箐滹滗滹换舶腐钡殚镤滹殚轶滹换舶动贝殚镤滹殚箝轱换钩背殚轶镤滗滗滹换烦辈殚轶滗镤滗滹换狈朝北殚篌轱潴殚轱换惫帛卑殚篌滗箐滗滹换舶矾购殚镤滹殚轶滗换拱负殚轶镤滗滗篌换共泛殚轶镤滗滗滗换钒逗殚轶潴殚殚殚换凡岛殚轶滗镤滗滗换惫隘春殚篌殚轱滗潴换惫悲澈殚篌滗箐滗滗换贡埠殚轶镤滗滗篌轱换繁焙殚轶潴殚殚殚轱换阵弪糸礤昂背撼钞舶换御篝屙糸礤泊辈换澎狃箦糸礤昂贝罕懂暗换领祜汜糸镱泊背贩刀返舶怡翦换侗荡掣嗅珏驷蹯趔换冕祆麸ヅ至北当兜暗父换（铫㈤铫㈤轱㈤殚铫㈤轶铫㈤轶轱㈤轶殚铫㈤殚箐滹㈤殚箐铫㈤殚箫㈤镤铫㈤镲㈤镩铫㈤镩轱㈤镩箫㈤镩箝铫㈤轶箫㈤轶箝铫㈤镩轶滹㈤镩轶铫㈤轱滗铫㈤轱滹㈤轱铫㈤轱轱㈤轱箫㈤轱箝铫㈤轱箝轱㈤轱轶滗铫㈤轱轶滹㈤轱轶铫㈤殚镩篌铫㈤殚镤滹㈤殚镤铫㈤殚镲㈤殚镩铫㈤殚镩轱㈤轶殚箫㈤殚矬滗铫㈤殚矬滹㈤殚矬铫㈤轶矬箫㈤轶矬箝铫㈤轶镤滹㈤轶镤铫㈤轶镲㈤轶镩铫㈤轶镩轱㈤轶镩殚铫㈤轶镤箐铫㈤轶镤箫㈤殚箐潴轱㈤殚箐潴殚铫㈤轶轱滗滹㈤轶轱滗铫㈤轶轱滹㈤轶轱铫㈤轶轱轱㈤轶轱殚铫㈤轶轱殚轱㈤轶轱滗箫㈤殚箐箐滗滹㈤殚箐箐滗铫㈤殚箐箐滹㈤殚箐箐铫㈤殚箐箫㈤殚箐箝铫㈤轶殚镲㈤轶殚镩铫㈤轶殚镩轱㈤轶殚镩殚铫㈤殚箐箝殚殚轱㈤殚箐箝殚殚殚铫㈤殚箐滹滗滗滹㈤殚箐滹滗滗铫㈤殚箐滹滗滹㈤殚箐滹滗铫㈤殚箐滹滹㈤殚箐滹铫㈤殚篌滗滹㈤殚篌滗铫㈤殚篌滹㈤殚篌铫㈤殚篌轱㈤殚篌殚铫㈤殚篌殚轱㈤殚篌殚殚铫㈤殚箐镤滹㈤殚箐镤铫㈤殚箐镲㈤殚箐镩铫㈤殚箫滗滗潴箫㈤殚箫滗滗潴箝铫㈤殚箫滗滗滗滹㈤殚箫滗滗滗铫㈤殚箫滗滗滹㈤殚箫滗滗铫㈤殚箫滗滹㈤殚箫滗铫㈤殚箫滹㈤殚箫铫㈤镤镲㈤镤镩铫㈤镤镩轱㈤镤镩殚铫㈤镤镩轶铫㈤镤镩轶轱㈤镤镩轶殚铫㈤殚箝镤滗铫㈤殚箝镤滹㈤殚箝镤铫㈤镲滹㈤镲铫㈤镲轱㈤镲殚铫㈤镲轶铫㈤镲轶轱㈤镩篌铫㈤镩篌轱㈤镲殚箐铫㈤镲殚箫㈤镩镤滹㈤镩镤铫㈤镩镲㈤镩镩铫㈤镩矬铫㈤镩矬轱㈤镩矬殚铫㈤镩镩箐滹㈤镩镩箐铫㈤镩镩箫㈤镩轱轶箫㈤镩轱滗铫㈤镩轱滹㈤镩轱铫㈤镩轱轱㈤镩轱殚铫㈤镩箝轶铫㈤镩轱箐滹㈤镩轱箐铫㈤镩轱箫㈤镩箫篌铫㈤镩箫篌轱㈤镩箫滗铫㈤镩箫滹㈤镩箫铫㈤镩箫轱㈤镩箫殚铫㈤镩箫殚轱㈤镩箫潴滹㈤镩箫潴铫㈤轶箐镩箫㈤轶箐镩箝铫㈤镩箝镤滗铫㈤镩箝镤滹㈤镩箝镤铫㈤镩箝镲㈤镩箝镩铫㈤镩箝镩轱㈤镩箝镩殚铫㈤镩箝镤潴铫㈤轶箫箫㈤轶箫箝铫㈤轶箫箝轱㈤镩轶潴滹㈤镩轶潴铫㈤镩轶潴轱㈤镩箝轱铫㈤镩箝轱轱㈤镩箝轱殚铫㈤轶箐滗箫㈤轶箝镤箫㈤轶箝镤箝铫㈤轶箝镤箝轱㈤轶箝镤箝殚铫㈤镩轶滗镤滗铫㈤镩轶滗镤滹㈤镩轶滗镤铫㈤镩轶滗镲㈤镩轶箐滗铫㈤镩轶箐滹㈤镩轶箐铫㈤镩轶箫㈤镩轶箝铫㈤镩轶箝轱㈤镩轶箝殚铫㈤镩轶箝殚轱㈤镩轶滹滗铫㈤镩轶滹滹㈤镩轶滹铫㈤镩轶滹轱㈤轶箝殚镤滗箫㈤轶箐潴滗滗滹㈤轶箐潴滗滗铫㈤轶箐潴滗滹㈤轶箐潴滗铫㈤轶箐潴滹㈤轶箐潴铫㈤镩轶镤滹㈤镩轶镤铫㈤镩轶镲㈤轱滗镲㈤轱滗镩铫㈤轱滗镩轱㈤轱滗镩殚铫㈤轱滗镩轶铫㈤轱滗镩轶轱㈤轱滗镩轶殚铫㈤轱滗镩殚箐滹㈤轱滗镩殚箐铫㈤轱滗镩殚箫㈤轱轶轱㈤轱滹铫㈤轱滹轱㈤轱滹殚铫㈤轱篌滗铫㈤轱篌滹㈤轱篌铫㈤轱篌轱㈤轱篌殚铫㈤轱篌殚轱㈤轱镤滹㈤轱镤铫㈤轱镲㈤轱镩铫㈤轱矬铫㈤轱矬轱㈤轱矬殚铫㈤轱镩箐滹㈤轱镩箐铫㈤轱镩箫㈤轱轱轶箫㈤轱轱滗铫㈤轱轱滹㈤轱轱铫㈤轱轱轱㈤轱轱殚铫㈤轱箝轶铫㈤轱轱箐滹㈤轱轱箐铫㈤轱轱箫㈤轱箫篌铫㈤轱箫篌轱㈤轱箫滗铫㈤轱箫滹㈤轱箫铫㈤轱箫轱㈤轱箫殚铫㈤轱箫殚轱㈤轱箫潴滹㈤轱箫潴铫㈤轱轶滗箝铫㈤轱轶滗箝轱㈤轱箝镤滗铫㈤轱箝镤滹㈤轱箝镤铫㈤轱箝镲换锰沼乓蝈漉沐＇篚怏羼暴弘妁＇戾铉翳换舶扯